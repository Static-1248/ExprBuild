# 项目信息与状态

### 项目介绍
1. **项目目标**：

	用户通过编写类似 `` const c = expr`${a}^2 + ${b}^2` `` 的代码，生成 Desmos 兼容的数学表达式，最终制作并导出 Desmos 图表。

	**ExprBuild 是：**
	- In short: 创作 Desmos 图表的 JS 框架。JS framework for creating Desmos graphs.
	- In long: 一个用于生成 Desmos 图表的 JS/TS 库，提供表达式的创建、组织，和 Desmos 图表生成等功能。同时提供开发服务器，支持实时预览和导出 Desmos 图表；以及 VSCode 插件，提供代码提示和语法高亮等功能。

	**ExprBuild 产品将包括：**
	- **JS/TS库**：核心库，提供表达式的创建、组织，和Desmos图表生成等功能。
	- **开发服务器**：提供本地开发环境，支持实时预览和导出Desmos图表。目前暂定依托于Vite实现开发体验，因而我们需要制作一个Vite插件。
	- **VSCode插件**：提供代码提示和DSL语法高亮等功能。
		> 本工程只包括vscode插件，但整个项目依然作为一个整体开发，所以我们在不同工程之间同步这份关于整个项目的文档。

2. **开发者背景**: 
	- 开发者熟悉js/ts和前端开发，但对vscode插件开发和DSL解析器开发不熟悉。
	- 开发者将使用Copilot等AI工具辅助开发，所以需要维护本文档以便AI工具理解项目背景、需求、进展等。

3. **技术细节**：

	> 在这里存放：代码尚未实现，所以无法在代码里体现，必须先在这里记一下的技术细节；其他必须在代码之外补充的技术细节。
	
    - Desmos 通过 JS API 动态加载，关键功能是Desmos计算器状态(state)对象的读写，示例代码：
        ```html
        <div id="calculator"></div>
        <script src="https://www.desmos.com/api/v1.8.0/calculator.js"></script>
        <script>
          const calculator = Desmos.Calculator(document.getElementById('calculator'));
          calculator.setState(生成的State对象);
        </script>
        ```
	- **ExprBuild DSL**：
		- 用户创建表达式的唯一方式是使用ExprBuild的模板字符串，如 `` const c = expr`${a}^2 + ${b}^2` ``。模板字符串内部为ExprBuild DSL.
			> 备注：这样子设计是因为JS不支持重载运算符，所以很难通过JS语法直接创建表达式对象...... 不过这也导致我们需要提供DSL开发支持（如vscode插件），否则用户的开发体验仍然会约等于0（）\
			> 实际上引入DSL不会导致用户的开发工程脱离原生，因为本质上这些DSL是运行时才会被解析的模板字符串（函数调用）。但是显然还是要为这里的DSL提供DevEx支持。
		- 模板字符串支持传入变量（且可以使用自定义的逻辑来处理这些变量），这允许了用户创建依赖于其他表达式的表达式。不过麻烦的地方在于输入一个变量名时必须输入“${变量名}”，略为繁琐，除非我们在vscode插件里提供代码提示/代码补全功能。
		- DSL表达式的最终类型（比如它是表达式还是函数还是无效表达式等）需要体现为TS类型，所以我们需要写亿点类型体操来推断DSL表达式的类型了（泪
		- DSL字符串不会直接作为Desmos的latex表达式，语法也不直接等效于Desmos+latex语法；ExprBuild DSL会被首先解析为ExprBuild对象，导出时再转换为Desmos的latex表达式。
		- DSL语法将在其他文档中详细介绍。

    - **ExprBuild 表达式依赖体系**:

	    ExprBuild 的表达式对象分为两种：显式表达式（explicit）和内联表达式（inline）。

        - **explicit 表达式 (使用`expl`定义):**：
            - **定义**：生成独立的变量定义式（如 `a=3`），会出现在 Desmos 表达式列表中，成为Desmos图形计算器的有效变量。
            - **示例**：``const a = expl`a = 3`;`` 定义了一个变量 `a`。
            - **作用**：在Desmos图形计算器里，这些变量一边完成被其他表达式引用。
        
        - **inline 表达式 (使用`expr`定义):**：
            - **定义**：生成内联表达式，会被替换为其符号内容，不会单独出现在表达式列表中。
            - **示例**：``const c = expr`${a}^2 + ${b}^2`;`` 生成了一个依赖于 `a` 和 `b` 的内联表达式。
            - **作用**：通常作为WIP/中间体等，在图象构建时这些表达式会将其内容代入所有引用它的地方，自身不会单独出现在表达式列表中。

        - **示例**
           
		    ```javascript
            const a = expl`a = 3`;
            const b = expl`b = 4`;
            const c = expr`${a}^2 + ${b}^2`;
	        ```

	    - **依赖管理**:
			
			每个 ExprBuild 表达式都会存储相关依赖信息。
			
			- 每个表达式对象保存其依赖的表达式对象的引用；
			- 每个表达式的内容在创建后无法修改，这意味着表达式的依赖关系在创建时就已经确定。
				> 备注：这样设计可能会导致自由度不够高等问题，但不采用这一点的话下面的"使用类型系统跟踪所有explicit依赖的变量名"就无法实现，因为“动态”就必然意味着“未知”。后面再考虑是否需要支持动态依赖关系。 
			- 每个表达式内记录其依赖的explicit表达式的变量名。同时如果使用TS，也会在类型系统里跟踪所有explicit依赖的变量名。
			- 在结构不可变的前提下，不会出现循环依赖的情况。
	        > 备注: 相关技术细节待补充。

### 当前进展
- 目前项目结构为一个vscode插件示例，我需要通过示例理解vscode插件的开发方式。

### 下一步计划

1. **整理项目结构**
   - 看看如何规划项目结构以同时包括核心库、开发服务器、和vscode插件。细节待定

2. **编写核心库框架**
   - 实现 `expl` 和 `expr` 的基本功能
   - 实现表达式对象的基本结构
   - 实现表达式对象的依赖关系管理

3. **实现 DSL 解析器**：
   - 输入：解析类似 `` expr`${a}^2 + ${b}` `` 的模板字符串
   - 输出：生成表达式字符串（如 `"a^2 + b"`），同时记录 `a` 和 `b` 的依赖关系
   - 要求：暂不处理运算符优先级，用户需手动添加括号

4. **依赖收集与 State 生成**：
   - 收集所有 `expl` 定义的变量（如 `a=3`）
   - 生成 Desmos 的 State 对象格式示例：
     ```json
     {
       "expressions": {
         "list": [
           { "type": "expression", "id": "a", "latex": "a = 3" },
           { "type": "expression", "id": "c", "latex": "a^2 + 3^2" }
         ]
       }
     }
     ```

5. **开发服务器基础**：
   - 通过 Express 启动本地服务器
   - 监听文件变动后全量更新 Desmos 计算器状态